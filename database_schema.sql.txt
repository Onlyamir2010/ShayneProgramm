-- 1. CLEANUP (Just in case partial tables exist)
drop table if exists production_logs cascade;
drop table if exists project_items cascade;
drop table if exists units cascade; -- Old table cleanup
drop table if exists floors cascade; -- Old table cleanup
drop table if exists projects cascade;
drop table if exists capacity_overrides cascade;
drop table if exists factory_calendar cascade;
drop table if exists work_lines cascade;

-- 2. CREATE TABLES
create table work_lines (
  id bigint generated by default as identity primary key,
  name text not null, 
  standard_capacity int default 0,
  unit_of_measure text
);

create table factory_calendar (
  id bigint generated by default as identity primary key,
  start_date date not null,
  end_date date not null,
  description text,
  is_working_day boolean default false
);

create table capacity_overrides (
  id bigint generated by default as identity primary key,
  work_line_id bigint references work_lines(id),
  start_date date not null,
  end_date date not null,
  new_capacity int not null
);

create table projects (
  id bigint generated by default as identity primary key,
  name text not null,
  is_modular boolean default false,
  priority int default 0,
  num_modules int default 0,
  pace_apollo int,
  pace_wall1 int,
  pace_wall2 int,
  pace_turbo int,
  pace_gow int,
  pace_mini8 int,
  pace_floor_line int,
  pace_ceiling_line int,
  pace_modular_hall float,
  floor_milestones jsonb default '{}'::jsonb,
  completion_date date,
  status text default 'Active',
  created_at timestamp with time zone default now()
);

create table project_items (
  id bigint generated by default as identity primary key,
  project_id bigint references projects(id) on delete cascade,
  name text not null,
  floor_number int,
  priority int default 0,
  vol_apollo int default 0,
  vol_wall1 int default 0,
  vol_wall2 int default 0,
  vol_turbo int default 0,
  vol_gow int default 0,
  vol_mini8 int default 0,
  vol_floor_cassette int default 0,
  vol_ceiling_cassette int default 0,
  pred_apollo text,
  pred_wall1 text,
  pred_wall2 text,
  pred_turbo text,
  pred_gow text,
  pred_mini8 text,
  pred_floor_cassette text,
  pred_ceiling_cassette text
);

create table production_logs (
  id bigint generated by default as identity primary key,
  date date not null,
  project_id bigint references projects(id),
  project_item_id bigint references project_items(id),
  done_apollo int default 0,
  done_wall1 int default 0,
  done_wall2 int default 0,
  done_turbo int default 0,
  done_gow int default 0,
  done_mini8 int default 0,
  done_floor_cassette int default 0,
  done_ceiling_cassette int default 0,
  current_station int,
  notes text
);

-- 3. INSERT DEFAULTS
insert into work_lines (name, standard_capacity, unit_of_measure) values
('Apollo Saw', 1130, 'LF'),
('Wall Line 1', 376, 'LF'),
('Wall Line 2', 400, 'LF'),
('Turbo Saw', 3300, 'BF'),
('GOW Table', 2600, 'BF'),
('Mini 8 Table', 1500, 'BF'),
('Floor Line', 1500, 'SF'),
('Ceiling Line', 1500, 'SF'),
('Modular Hall', 1, 'Station');

-- 4. ENABLE PERMISSIONS (The "Open Gates" Command)
alter table projects enable row level security;
alter table project_items enable row level security;
alter table production_logs enable row level security;
alter table work_lines enable row level security;

create policy "Enable all access for projects" on projects for all using (true) with check (true);
create policy "Enable all access for items" on project_items for all using (true) with check (true);
create policy "Enable all access for logs" on production_logs for all using (true) with check (true);
create policy "Enable all access for worklines" on work_lines for all using (true) with check (true);
